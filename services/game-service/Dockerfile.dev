
FROM node:20-bookworm-slim

ENV NPM_CONFIG_UPDATE_NOTIFIER=false
WORKDIR /app

# Install deps first
COPY package.json ./
COPY package-lock.json* ./
RUN npm install --no-audit --no-fund

# Bring in the shared protocol
COPY --from=protocol . /app/protocol

RUN npm install --no-audit --no-fund ./protocol

# Copy config + sources
COPY tsconfig.json ./
COPY src ./src

EXPOSE 3100
CMD ["npm", "run", "dev"]
