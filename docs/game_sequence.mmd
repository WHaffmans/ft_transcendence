sequenceDiagram
    participant U as User
    participant SPA as SPA Client
    participant API as Backend Service
    participant WS as Game WS Service
    participant DB as Database

    U->>SPA: Login
    note right of SPA: User is authenticated (no action yet)

    U->>SPA: Click "Find Game"
    SPA->>API: HTTP POST /find-game

    API->>DB: Query games registry(pending/active)
    DB-->>API: Matching game or none

    alt No applicable game
        API->>DB: Create new game
    end

    API->>DB: Update user_game pivot table
    DB-->>API: OK

    API-->>SPA: gameId

    SPA->>SPA: Redirect to /lobby/{gameId}

    SPA->>WS: Open WebSocket connection
    WS-->>SPA: WS connected

    SPA->>WS: join_room { gameId, userId }
    WS->>WS: Find or create room(channel)
    WS->>WS: Add socket to room
    WS-->>SPA: user_joined event (broadcast to room)

    note over SPA: All connected clients receive event

    SPA->>API: HTTP GET /games/{gameId}
    API->>DB: Fetch game + players
    DB-->>API: Game state
    API-->>SPA: Updated game data
    SPA->>SPA: Update lobby UI

    %% --- Start Game flow ---
    alt Host clicks "Start Game"
        U->>SPA: Click "Start Game"
        SPA->>API: HTTP POST /games/{gameId}/start

        API->>DB: Validate permissions + state\n(status == lobby)
        API->>DB: Update games.status=started



        API->>WS: HTTP POST /internal/games/{gameId}/started
        WS-->>API: 200 OK
        API-->>SPA: 200 OK (started)
        WS->>WS: Mark room as "in-game" -> start game tick / state broadcaster
        WS-->>SPA: game_started {gameId, startedAt} (broadcast to room)
        SPA->>SPA: Redirect to /game/{gameId}
        WS-->>SPA: game_state snapshot (optional)
    end


    loop During game
        WS-->>SPA: game_state_update / tick messages
    end